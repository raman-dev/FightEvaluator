<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Fighter Assessment: {{ fighter.first_name.capitalize() }} {{ fighter.last_name.capitalize() }}</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.css"
      integrity="sha512-r0fo0kMK8myZfuKWk9b6yY8azUnHCPhgNz/uWDl2rtMdWJlk7gmd9socvGZdZzICwAkMgfTkVrplDahQ07Gi0A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', path='/styles/styles.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', path='/styles/assessment_styles.css') }}" />

  </head>
  <body data-bs-theme="dark">
    {% include 'navbar.html' %}
    <div class="main-container xmain-container">
      <div class="fighter-info-container">
        <div class="fighter-card">
          <img class="fighter-image" src="{{ fighter.img_link if fighter.img_link !=None else url_for('static',path='/media/sample_150.png') }}"alt="">
          <div class="content-wrapper">
            <div class="card-content">
              <div class="card-header">
                <h2 class="fighter-name">{{ fighter.first_name }} {{ fighter.last_name }}</h2>
                <div class="info-wrapper">
                  <h5 class="fighter-weight">{{ fighter.weight_class|weightClassToStr }}</h5>
                </div>
              </div>
              <div class="card-body">
                <div class="info-wrapper">
                  <label>height:&nbsp;</label>
                  <h6 class="fighter-height">{{ fighter.height }}</h6>
                </div>
                <div class="info-wrapper">
                  <label>age:&nbsp;</label>
                  <h6 class="fighter-age">age</h6>
                </div>
                <div class="info-wrapper">
                  <label>record:&nbsp;</label>
                  <h6 class="fighter-record">{{ fighter.record }}</h6>
                </div>
                <div class="info-wrapper">
                  <label>reach:&nbsp;</label>
                  <h6 class="fighter-reach">{{ fighter.reach }}</h6>
                </div>
                <div class="info-wrapper">
                  <label>stance:&nbsp;</label>
                  <h6 class="fighter-stance">{{ fighter.stance }}</h6>
                </div>
              </div>
            </div>
            <div class="button-container">
              <button class="bio-edit-button">edit</button>
              <button class="bio-commit-button" onclick="updateFighterImgLink()">commit</button>
            </div>
          </div>
          
        </div>
        <div class="img-link edit-element" >{{ fighter.img_link if fighter.img_link !=None else url_for('static',path='/media/sample_150.png') }}</div>
      </div>
      <div class="fighter-grid-container">
          <!--list of 8 fighter attributes-->
        <div class="fighter-attrib-list" data-edit-mode-enabled="false">
          <!-- <div class="attrib-card" data-edit-mode-enabled="false" data-attrib-state="null">
            <div class="card-header">
              <div class="state-container">
                <h4>Attribute-X</h4>
                 <svg
                  class="arrow"
                    xmlns="http://www.w3.org/2000/svg"
                    height="24"
                    viewBox="0 -960 960 960"
                    width="24">
                    <path
                      fill="white"
                      d="m560-240-56-58 142-142H160v-80h486L504-662l56-58 240 240-240 240Z" />
                  </svg>
              <div class="card-state">State X</div>
              </div>
              <div class="button-container">
                <button class="attrib-edit-button">edit</button>
                <button class="attrib-commit-button">commit</button>
              </div>
            </div>
            <div class="card-body">
                <div class="attrib-option" data-option-state="positive">
                  Option 0
                </div>
                <div class="attrib-option" data-option-state="neutral">
                  Option 1
                </div>
                <div class="attrib-option" data-option-state="negative">
                  Option 2
                </div>
            </div>
            <div class="card-footer">
              <div class="attrib-option-description" data-option-state="positive">
                <p>Option 0 description</p>
              </div>
              <div class="attrib-option-description" data-option-state="neutral">
                <p>Option 1 description</p>
              </div>
              <div class="attrib-option-description" data-option-state="negative">
                <p>Option 2 description</p>
              </div>
            </div>
          </div>
           -->
          {% for attrib_name,attrib_value in assessment.__dict__.items() %}
            {% if loop.index != 1 and attrib_name != 'id' %}
              <div class="attrib-card" data-edit-mode-enabled="false" data-attrib-state="{{ attrib_value|attribToStr }}" data-attrib-name="{{ attrib_name }}">
                <div class="card-header">
                  <div class="state-container">
                    <h4>{{ attrib_name|attribNameToStr }}</h4>
                     <svg
                      class="arrow"
                        xmlns="http://www.w3.org/2000/svg"
                        height="24"
                        viewBox="0 -960 960 960"
                        width="24">
                        <path
                          fill="white"
                          d="m560-240-56-58 142-142H160v-80h486L504-662l56-58 240 240-240 240Z" />
                      </svg>
                  <div class="card-state">{{ attrib_name|attribToStateStr(attrib_value) }}</div>
                  </div>
                  <div class="button-container">
                    <button class="attrib-edit-button">edit</button>
                    <button class="attrib-commit-button">commit</button>
                  </div>
                </div>
                <div class="card-body">
                  <!--attribute state options container-->
                    <div class="attrib-option" data-option-state="positive" {{ "selected" if attrib_value|attribToStr=="positive" }} >
                      <p>Option 0</p>
                    </div>
                    {% if attrib_name != 'grappling_offense' and attrib_name !='grappling_defense' %}
                    <div class="attrib-option" data-option-state="neutral" {{ "selected" if attrib_value|attribToStr =="neutral"}} >
                      <p>Option 1</p>
                    </div>
                    {% endif %}
                    <div class="attrib-option" data-option-state="negative" {{ "selected" if attrib_value|attribToStr =="negative"}} >
                      <p>Option 2</p>
                    </div>
                    <div class="attrib-option" data-option-state="untested" {{ "selected" if attrib_value|attribToStr =="untested"}} >
                      <p>untested</p>
                    </div>
                </div>
                <div class="card-footer">
                  <div class="attrib-option-description" data-option-state="positive" {{ "selected" if attrib_value|attribToStr=="positive" }}>
                    <p>Option 0 description</p>
                  </div>
                  {% if attrib_name != 'grappling_offense' and attrib_name != 'grappling_defense'  %}
                  <div class="attrib-option-description" data-option-state="neutral" {{ "selected" if attrib_value|attribToStr=="neutral" }}>
                    <p>Option 1 description</p>
                  </div>
                  {% endif %}
                  <div class="attrib-option-description" data-option-state="negative" {{ "selected" if attrib_value|attribToStr=="negative" }}>
                    <p>Option 2 description</p>
                  </div>
                  <div class="attrib-option-description" data-option-state="untested" {{ "selected" if attrib_value|attribToStr=="untested" }}>
                    <p>untested</p>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
          
        </div>
        <!--additional notes and context info to consider about a particular fighter-->
        <div class="fighter-notes list-group-item d-flex flex-column">
          <!--list of text notes about a the fighter in jot note style-->
          <div class="notes-title">
            <h4>Notes - Things to consider about this fighter...</h4>
          </div>
          <!--unordered scrollable list of p tags wrapped in li-->
          <!--textarea made with div and contenteditable -->
          <div class="note-editor-container d-flex flex-column">
            <button
              class="btn btn-success note-submit-btn"
              onclick="addNote(event)">
              submit
            </button>
            <div
              class="note-editor align-self-center"
              contenteditable="plaintext-only"></div>
          </div>
          <div class="notes-list align-self-center mt-4">
            <ul class="dx-none">
              {% for note in notes %}
              <li class="note" data-note-id="{{ note.id }}">
                <p>{{ note.data }}</p>
                <!-- <button
                  class="btn btn-danger note-delete-btn"
                  data-note-id="{{ note.id }}"
                  onclick="deleteNote(event)">
                  delete
                </button> -->
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      
    </div>
    <script src="{{ url_for('static',path='/js/definitions.js')}}"></script>
    <script>
      var editModeEnabled = false;
      const fighter_id = {{ fighter.id }};//parseInt(window.location.href.split("/").pop());
      const assessment_id = {{ assessment.id }};
      var fighterImgLink = {{ fighter.img_link|fightLinkFilter if assessment.img_link is not none else 'null' }};
      const assessment_data = {
        id: {{ assessment.id }},
        head_movement: {{ assessment.head_movement|fightAttribQualifier if assessment.head_movement is not none else 'null' }},
        gas_tank: {{ assessment.gas_tank|fightAttribQualifier if assessment.gas_tank is not none else 'null' }},
        aggression: {{ assessment.aggression|fightAttribQualifier if assessment.aggression is not none else 'null' }},
        striking: {{ assessment.striking|fightAttribQualifier if assessment.striking is not none else 'null' }},
        desire_to_win: {{ assessment.desire_to_win|fightAttribQualifier if assessment.desire_to_win is not none else 'null' }},
        chinny: {{ assessment.chinny|fightAttribQualifier if assessment.chinny is not none else 'null' }},
        grappling_offense: {{ assessment.grappling_defense|fightAttribQualifier if assessment.grappling_offense is not none else 'null' }},
        grappling_defense: {{ assessment.grappling_defense|fightAttribQualifier if assessment.grappling_defense is not none else 'null' }},
      };

      //set a cookie for the assessment_id so that i know which assessment was viewed last
      document.cookie = `assessment_id=${assessment_id};SameSite=strict;path=/;max-age=31536000`;
      //print all cookies
      
      for (key in attribInfoMap){
        //grab attrib-card
        let attribCard = document.querySelector(`[data-attrib-name="${key}"]`);

        attribCard.querySelectorAll('.attrib-option').forEach((attribOption)=>{
          //grab option state
          let optionState = attribOption.getAttribute('data-option-state');
          attribOption.querySelector('p').textContent = attribInfoMap[key][optionState].state;
        });

        attribCard.querySelectorAll('.attrib-option-description').forEach((attribDescription)=>{
          //grab option state
          let optionState = attribDescription.getAttribute('data-option-state');
          let p = attribDescription.querySelector('p');
          p.textContent = attribInfoMap[key][optionState].description;
        });
      }

      if (fighterImgLink != null){
        document.querySelector('img').setAttribute('src',fighterImgLink);
      }

      //grab bio edit button
      let bioEditButton = document.querySelector(".bio-edit-button");
      bioEditButton.addEventListener("click", (event) => {
        //toggle edit mode
        editModeEnabled = !editModeEnabled;
        let fighterCard = document.querySelector(".fighter-card");
        let link = document.querySelector('.img-link');
        if (editModeEnabled){
          //make img-link editable
          link.style.opacity = '1';
          link.setAttribute('contenteditable','plaintext-only');
          fighterCard.setAttribute("data-edit-mode-enabled", "true");
        }else{
          link.removeAttribute('contenteditable');
          link.style.opacity = '0';
          fighterCard.setAttribute("data-edit-mode-enabled", "false");
        }
      });
      //grab content from note-editor and send it to the server
      //update the notes-list with the new note
      async function addNote(event) {
        //from note-editor get the text content make sure it is non empty
        let noteEditor = document.querySelector(".note-editor");
        let noteText = noteEditor.textContent.trim();
        if (noteText.length > 0) {
          //post request to server with new note
          let response = await fetch("/notes", {
            method: "POST",
            headers: {
              accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              assessment_id: assessment_id,
              data: noteText,
            }),
          });
          let noteData = await response.json();
          let notesContainer = document.querySelector(".notes-list");
          notesContainer.classList.remove('dx-none');
          //create a new li element with the noteText
          let newNote = document.createElement("li");
          newNote.classList.add("note");
          newNote.setAttribute("data-note-id", noteData.id);
          newNote.innerHTML = "<p>" + noteText + "</p>";
          newNote.setAttribute("data-note-id", noteData.id);
          //append the new li element to the notes-list
          let notesList = document.querySelector(".notes-list ul");
          notesList.classList.remove('dx-none');//if there are no notes, remove the d-none class
          notesList.prepend(newNote);
          //clear the note-editor
          noteEditor.textContent = "";
        }
      }

      async function deleteNote(event) {
        //get the note id from the note element
        //send delete request to server
        //remove note from notes-list
        let note_id = parseInt(event.target.getAttribute("data-note-id"));
        let response = await fetch(`/notes/${note_id}`, {
          method: "DELETE",
          headers: {
            accept: "application/json",
            "Content-Type": "application/json",
          },
        });
        console.log(response);
      }

      function dobToAge(dob) {
        let today = new Date();
        let birthDate = new Date(dob);
        let age = today.getFullYear() - birthDate.getFullYear();
        let m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
          age--;
        }
        return age;
      }

     
      let fighterAge = document.querySelector(".fighter-age");
      fighterAge.textContent = dobToAge('{{ fighter.date_of_birth }}');

      async function updateFighterImgLink(){
        if (!editModeEnabled){
          return;
        }
        let newLink = document.querySelector('.img-link').textContent;
        if (newLink == fighterImgLink){
          return;
        }
        //send fighter link update to server
        let response = await fetch(`/fighters/updateImageLink`, {
          method: "PATCH",
          headers: {
            accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            fighter_id: fighter_id,
            img_link: newLink,
          }),
        });

        if (response.status == 200){
          console.log('img link updated');
          //update imglink in page
          let imgLink = document.querySelector('.img-link');
          fighterImgLink = newLink;
        }
        
      }
      
      let notesList = document.querySelector('.notes-list');
      let notesListUl = document.querySelector(".notes-list ul");
      //fix .fighter-notes to have max height as the height of attribute list
      let notesContainer = document.querySelector(".fighter-notes");
      let attribList = document.querySelector(".fighter-attrib-list");
      //get padding of notesContainer
      let notesContainerStyle = window.getComputedStyle(notesContainer);
      let paddingMarginOffset = parseInt(notesContainerStyle.paddingBottom) + parseInt(notesContainerStyle.marginBottom);
      notesListUl.style.maxHeight = (attribList.offsetHeight - notesList.offsetTop - paddingMarginOffset) + "px";
      if (notesListUl.children.length > 0){
        notesListUl.classList.remove('dx-none');
      }
    
    
    </script>
    <script src="{{ url_for('static', path='/js/attribute-interaction.js') }}"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.js"
      integrity="sha512-ipBeSMCnlAvS4AEbycy0nTk9KkYr5lUJwFHNvf4IxtV/CDW4qx53mZKUryWtNr6GFaBl11EXyrU6iE3mo6ib2g=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"></script>
  </body>
</html>
